{% load static %}
{% load humanize %}

<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Checkout - Glowin</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Estilos externos -->
    <link rel="stylesheet" href="{% static 'checkout/css/checkout.css' %}">
</head>

<body class="bg-light">

    <div class="container my-5">

        <h2 class="text-center mb-4" style="color:#d63384;">Finalizar compra</h2>

        <!-- Barra de progreso -->
        <div class="checkout-progress">
            <div class="progress-steps">

                <div class="step-item active" id="prog-1">
                    <div class="circle">1</div>
                    <span>Contacto</span>
                </div>

                <div class="line" id="line-1"></div>

                <div class="step-item" id="prog-2">
                    <div class="circle">2</div>
                    <span>Envío</span>
                </div>

                <div class="line" id="line-2"></div>

                <div class="step-item" id="prog-3">
                    <div class="circle">3</div>
                    <span>Resumen</span>
                </div>

            </div>
        </div>

        <form method="POST">
            {% csrf_token %}

            <!-- ========== PASO 1 ========== -->
            <div id="step1" class="checkout-box">
                <h4>Información de contacto</h4>

                <label>Nombre</label>
                <input type="text" name="nombre" class="form-control" required>

                <label>Apellido</label>
                <input type="text" name="apellido" class="form-control" required>

                <label>Correo electrónico</label>
                <input type="email" name="email" class="form-control" required>

                <button type="button" class="btn btn-dark w-100 mt-3" onclick="goToStep(2)">Continuar ➜</button>
            </div>

            <!-- ========== PASO 2 ========== -->
            <div id="step2" class="checkout-box hidden">
                <h4>Dirección de envío</h4>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Nombre</label>
                        <input type="text" name="nombre" class="form-control" required>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>Apellidos</label>
                        <input type="text" name="apellido" class="form-control" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label>Dirección completa</label>
                    <input type="text" name="direccion" class="form-control" required>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Ciudad</label>
                        <input type="text" name="ciudad" class="form-control" required>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>Departamento</label>
                        <input type="text" name="departamento" class="form-control" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label>Teléfono</label>
                    <input type="text" name="telefono" class="form-control" required>
                </div>

                <h4 class="mt-4">Método de envío</h4>

                <div id="envioOpciones">
                    <!-- Las 3 opciones → ahora usan CSS externo -->
                    {% include 'includes/checkout_envios.html' %}
                </div>

                <input type="hidden" name="costo_envio" id="costoEnvio" value="0">

                <div class="d-flex justify-content-between mt-3">
                    <button type="button" class="btn btn-outline-dark" onclick="goToStep(1)">⬅ Volver</button>
                    <button type="button" class="btn btn-dark" onclick="goToStep(3)">Continuar ➜</button>
                </div>
            </div>

            <!-- ========== PASO 3 ========== -->
            <div id="step3" class="checkout-box hidden">

                <h4>Resumen del pedido</h4>

                <div class="order-summary mb-3">
                    {% for item in items %}
                    {% include 'includes/checkout_item.html' %}
                    {% endfor %}

                    <div class="text-end mt-3">
                        <h5>Total: <strong class="text-success">$ {{ total|intcomma }}</strong></h5>
                    </div>
                </div>

                <div class="text-end">
                    <span class="text-muted">Envío:</span>
                    <strong id="envioResumen">$0</strong>
                </div>

                <button type="button" class="btn btn-outline-dark mt-3" onclick="goToStep(2)">⬅ Volver</button>

                <!-- Mercado Pago -->
                <div id="wallet_container" class="mt-4"></div>

                <script src="https://sdk.mercadopago.com/js/v2"></script>
                <script>
                    const mp = new MercadoPago("{{ MP_PUBLIC_KEY }}", { locale: "es-CO" });

                    fetch("/productos/crear-preferencia/")
                        .then(res => res.json())
                        .then(data => {
                            if (data.preference_id)
                                mp.bricks().create("wallet", "wallet_container", {
                                    initialization: { preferenceId: data.preference_id }
                                });
                        });
                </script>

            </div>

        </form>

    </div>

    <!-- JS EXTERNO -->
    <script src="{% static 'checkout/js/checkout.js' %}"></script>

</body>

</html>